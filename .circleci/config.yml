version: 2.1

orbs:
  git: opuscapita/git@volatile

aliases:
  - &restore_cache
    keys:
      - v1-{{ .Branch }}-{{ checksum "package.json" }}
      - v1-{{ .Branch }}
      - v1

  - &save_cache
    key: v1-{{ .Branch }}-{{ checksum "package.json" }}
    paths:
      - node_modules
      - ~/.m2/repository

setup_docker: &setup_docker
  docker:
    - image: opuscapita/minsk-core-ci:2
      auth:
        username: $DOCKER_USER
        password: $DOCKER_PASS
  working_directory: ~/build

jobs:
  init:
    docker:
      - image: opuscapita/minsk-core-machineuser-env:2
    steps:
      - run: circle_ci_add_env.sh

  build:
    <<: *setup_docker
    steps:
      - git/checkout-with-submodules
      - restore_cache: *restore_cache
      - run: make refresh-dependencies
      - run: make test
      - run: make build
      - run: make mvn-deploy
      - run:
          name: Cleanup local repository before saving its content into cache
          command: |
            export PROJECT_GROUP_ID=`mvn -q -Dexec.executable="echo" -Dexec.args='${project.groupId}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec 2>/dev/null`
            rm -rfv "~/.m2/repository/${PROJECT_GROUP_ID//.//}"
            du -sh ~/.m2/repository
      - save_cache: *save_cache
      - setup_remote_docker
      - run: make build-docker
      - run: make publish-docker

workflows:
  version: 2
  commit:
    jobs:
      - init:
          filters:
            tags:
              only: /.*/
      - build:
          filters:
            tags:
              only: /.*/
          requires:
            - init
